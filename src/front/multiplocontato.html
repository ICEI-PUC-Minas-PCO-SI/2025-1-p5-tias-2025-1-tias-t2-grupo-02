// Sistema de M√∫ltiplos Contatos
// Casa de Repouso Do Jeitinho da Vov√≥

/**
 * Gerenciador de m√∫ltiplos contatos
 */
class MultipleContactsManager {
    constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.contacts = [];
        this.nextId = 1;
        this.maxContacts = 5; // Limite m√°ximo de contatos
        
        this.init();
    }

    /**
     * Inicializa o gerenciador
     */
    init() {
        // Adiciona o primeiro contato (principal)
        this.addContact(true);
        this.updateAddButton();
    }

    /**
     * Adiciona um novo contato
     * @param {boolean} isPrimary - Se √© o contato principal
     */
    addContact(isPrimary = false) {
        if (this.contacts.length >= this.maxContacts) {
            alert(`M√°ximo de ${this.maxContacts} contatos permitidos.`);
            return;
        }

        const contactId = this.nextId++;
        const contact = {
            id: contactId,
            isPrimary: isPrimary,
            element: this.createContactElement(contactId, isPrimary)
        };

        this.contacts.push(contact);
        this.container.appendChild(contact.element);
        
        // Aplica valida√ß√µes aos campos do novo contato
        this.applyValidationsToContact(contactId);
        
        this.updateAddButton();
        this.updateContactTitles();
    }

    /**
     * Remove um contato
     * @param {number} contactId - ID do contato a ser removido
     */
    removeContact(contactId) {
        const contactIndex = this.contacts.findIndex(c => c.id === contactId);
        if (contactIndex === -1) return;

        const contact = this.contacts[contactIndex];
        
        // N√£o permite remover o contato principal se for o √∫nico
        if (contact.isPrimary && this.contacts.length === 1) {
            alert('Pelo menos um contato deve ser mantido.');
            return;
        }

        // Se remover o contato principal, torna o pr√≥ximo como principal
        if (contact.isPrimary && this.contacts.length > 1) {
            const nextContact = this.contacts.find(c => c.id !== contactId);
            if (nextContact) {
                nextContact.isPrimary = true;
                this.updateContactElement(nextContact);
            }
        }

        // Remove o elemento do DOM
        contact.element.remove();
        
        // Remove do array
        this.contacts.splice(contactIndex, 1);
        
        this.updateAddButton();
        this.updateContactTitles();
    }

    /**
     * Define um contato como principal
     * @param {number} contactId - ID do contato
     */
    setPrimaryContact(contactId) {
        // Remove o status principal de todos os contatos
        this.contacts.forEach(contact => {
            contact.isPrimary = false;
            this.updateContactElement(contact);
        });

        // Define o novo contato principal
        const contact = this.contacts.find(c => c.id === contactId);
        if (contact) {
            contact.isPrimary = true;
            this.updateContactElement(contact);
        }
    }

    /**
     * Cria elemento HTML para um contato
     * @param {number} contactId - ID do contato
     * @param {boolean} isPrimary - Se √© o contato principal
     * @returns {HTMLElement}
     */
    createContactElement(contactId, isPrimary) {
        const div = document.createElement('div');
        div.className = 'contato-item';
        div.setAttribute('data-contact-id', contactId);
        
        div.innerHTML = `
            <div class="contato-header">
                <span class="contato-titulo">
                    ${isPrimary ? 'Contato Principal' : `Contato ${contactId}`}
                    ${isPrimary ? '<span class="badge-principal">Principal</span>' : ''}
                </span>
                <div class="contato-actions">
                    ${!isPrimary ? `<button type="button" class="btn-set-primary" onclick="contactsManager.setPrimaryContact(${contactId})" title="Tornar principal">‚≠ê</button>` : ''}
                    ${this.contacts.length > 0 ? `<button type="button" class="btn-remover-contato" onclick="contactsManager.removeContact(${contactId})" title="Remover contato">üóëÔ∏è</button>` : ''}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="contato_nome_${contactId}" class="required">Nome</label>
                    <input type="text" id="contato_nome_${contactId}" name="contato_nome_${contactId}" required placeholder="Nome completo do contato">
                </div>

                <div class="form-group">
                    <label for="contato_parentesco_${contactId}">Parentesco</label>
                    <select id="contato_parentesco_${contactId}" name="contato_parentesco_${contactId}">
                        <option value="">Selecione</option>
                        <option value="filho">Filho(a)</option>
                        <option value="neto">Neto(a)</option>
                        <option value="irmao">Irm√£o/Irm√£</option>
                        <option value="sobrinho">Sobrinho(a)</option>
                        <option value="primo">Primo(a)</option>
                        <option value="cunhado">Cunhado(a)</option>
                        <option value="genro_nora">Genro/Nora</option>
                        <option value="amigo">Amigo(a)</option>
                        <option value="vizinho">Vizinho(a)</option>
                        <option value="cuidador">Cuidador(a)</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="contato_telefone_${contactId}" class="required">Telefone</label>
                    <input type="tel" id="contato_telefone_${contactId}" name="contato_telefone_${contactId}" required placeholder="(00) 00000-0000" maxlength="15">
                </div>

                <div class="form-group">
                    <label for="contato_telefone2_${contactId}">Telefone Alternativo</label>
                    <input type="tel" id="contato_telefone2_${contactId}" name="contato_telefone2_${contactId}" placeholder="(00) 00000-0000" maxlength="15">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="contato_email_${contactId}">Email</label>
                    <input type="email" id="contato_email_${contactId}" name="contato_email_${contactId}" placeholder="email@exemplo.com">
                </div>

                <div class="form-group">
                    <label for="contato_disponibilidade_${contactId}">Disponibilidade</label>
                    <select id="contato_disponibilidade_${contactId}" name="contato_disponibilidade_${contactId}">
                        <option value="">Selecione</option>
                        <option value="24h">24 horas</option>
                        <option value="comercial">Hor√°rio comercial</option>
                        <option value="emergencia">Apenas emerg√™ncias</option>
                        <option value="fins_semana">Fins de semana</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="contato_endereco_${contactId}">Endere√ßo</label>
                <textarea id="contato_endereco_${contactId}" name="contato_endereco_${contactId}" rows="2" placeholder="Endere√ßo completo do contato"></textarea>
            </div>

            <div class="form-group">
                <label for="contato_observacoes_${contactId}">Observa√ß√µes</label>
                <textarea id="contato_observacoes_${contactId}" name="contato_observacoes_${contactId}" rows="2" placeholder="Observa√ß√µes sobre este contato"></textarea>
            </div>

            <input type="hidden" name="contato_principal_${contactId}" value="${isPrimary}">
        `;

        return div;
    }

    /**
     * Atualiza elemento de um contato
     * @param {Object} contact - Objeto do contato
     */
    updateContactElement(contact) {
        const titleElement = contact.element.querySelector('.contato-titulo');
        const hiddenInput = contact.element.querySelector(`input[name="contato_principal_${contact.id}"]`);
        
        if (contact.isPrimary) {
            titleElement.innerHTML = 'Contato Principal <span class="badge-principal">Principal</span>';
            hiddenInput.value = 'true';
        } else {
            titleElement.innerHTML = `Contato ${contact.id}`;
            hiddenInput.value = 'false';
        }

        // Atualiza bot√µes de a√ß√£o
        const actionsDiv = contact.element.querySelector('.contato-actions');
        actionsDiv.innerHTML = `
            ${!contact.isPrimary ? `<button type="button" class="btn-set-primary" onclick="contactsManager.setPrimaryContact(${contact.id})" title="Tornar principal">‚≠ê</button>` : ''}
            ${this.contacts.length > 1 || !contact.isPrimary ? `<button type="button" class="btn-remover-contato" onclick="contactsManager.removeContact(${contact.id})" title="Remover contato">üóëÔ∏è</button>` : ''}
        `;
    }

    /**
     * Atualiza t√≠tulos de todos os contatos
     */
    updateContactTitles() {
        this.contacts.forEach(contact => {
            this.updateContactElement(contact);
        });
    }

    /**
     * Atualiza visibilidade do bot√£o adicionar
     */
    updateAddButton() {
        const addButton = document.querySelector('.btn-adicionar-contato');
        if (addButton) {
            if (this.contacts.length >= this.maxContacts) {
                addButton.style.display = 'none';
            } else {
                addButton.style.display = 'flex';
                addButton.innerHTML = `Adicionar Contato (${this.contacts.length}/${this.maxContacts})`;
            }
        }
    }

    /**
     * Aplica valida√ß√µes aos campos de um contato
     * @param {number} contactId - ID do contato
     */
    applyValidationsToContact(contactId) {
        // Nome
        const nomeField = document.getElementById(`contato_nome_${contactId}`);
        if (nomeField) {
            aplicarValidacao(nomeField, validarNome, 'Nome deve conter apenas letras e ter pelo menos 2 caracteres');
        }

        // Telefone principal
        const telefoneField = document.getElementById(`contato_telefone_${contactId}`);
        if (telefoneField) {
            aplicarValidacao(telefoneField, validarTelefone, 'Telefone inv√°lido');
            telefoneField.addEventListener('input', function() {
                let valor = this.value.replace(/[^\d]/g, '');
                if (valor.length <= 11) {
                    this.value = formatarTelefone(valor);
                }
            });
        }

        // Telefone alternativo
        const telefone2Field = document.getElementById(`contato_telefone2_${contactId}`);
        if (telefone2Field) {
            aplicarValidacao(telefone2Field, (valor) => !valor || validarTelefone(valor), 'Telefone alternativo inv√°lido');
            telefone2Field.addEventListener('input', function() {
                let valor = this.value.replace(/[^\d]/g, '');
                if (valor.length <= 11) {
                    this.value = formatarTelefone(valor);
                }
            });
        }

        // Email
        const emailField = document.getElementById(`contato_email_${contactId}`);
        if (emailField) {
            aplicarValidacao(emailField, (valor) => !valor || validarEmail(valor), 'Email inv√°lido');
        }
    }

    /**
     * Obt√©m todos os contatos como DTOs
     * @returns {ContatoDTO[]}
     */
    getContactsAsDTO() {
        return this.contacts.map(contact => {
            const formData = new FormData();
            const fields = contact.element.querySelectorAll('input, select, textarea');
            
            fields.forEach(field => {
                formData.append(field.name, field.value);
            });

            const dto = new ContatoDTO();
            dto.nome = formData.get(`contato_nome_${contact.id}`) || '';
            dto.parentesco = formData.get(`contato_parentesco_${contact.id}`) || '';
            dto.telefone = formData.get(`contato_telefone_${contact.id}`) || '';
            dto.telefoneAlternativo = formData.get(`contato_telefone2_${contact.id}`) || '';
            dto.email = formData.get(`contato_email_${contact.id}`) || '';
            dto.endereco = formData.get(`contato_endereco_${contact.id}`) || '';
            dto.observacoes = formData.get(`contato_observacoes_${contact.id}`) || '';
            dto.disponibilidade = formData.get(`contato_disponibilidade_${contact.id}`) || '';
            dto.principal = contact.isPrimary;

            return dto;
        });
    }

    /**
     * Valida todos os contatos
     * @returns {Object} - {isValid: boolean, errors: string[]}
     */
    validateAllContacts() {
        const errors = [];
        let isValid = true;

        this.contacts.forEach((contact, index) => {
            const dto = this.getContactsAsDTO()[index];
            const validation = dto.validate();
            
            if (!validation.isValid) {
                errors.push(...validation.errors.map(error => 
                    `${contact.isPrimary ? 'Contato Principal' : `Contato ${index + 1}`}: ${error}`
                ));
                isValid = false;
            }
        });

        // Verifica se h√° pelo menos um contato principal
        const hasMainContact = this.contacts.some(c => c.isPrimary);
        if (!hasMainContact && this.contacts.length > 0) {
            errors.push('Deve haver pelo menos um contato principal');
            isValid = false;
        }

        return { isValid, errors };
    }

    /**
     * Limpa todos os contatos
     */
    clearAllContacts() {
        this.contacts.forEach(contact => {
            contact.element.remove();
        });
        this.contacts = [];
        this.nextId = 1;
        
        // Adiciona o contato principal novamente
        this.addContact(true);
        this.updateAddButton();
    }
}

// Estende o ContatoDTO para incluir campos adicionais
class ContatoEstendidoDTO extends ContatoDTO {
    constructor() {
        super();
        this.telefoneAlternativo = '';
        this.disponibilidade = '';
        this.observacoes = '';
    }

    validate() {
        const baseValidation = super.validate();
        const errors = [...baseValidation.errors];

        // Valida√ß√£o do telefone alternativo
        if (this.telefoneAlternativo && !validarTelefone(this.telefoneAlternativo)) {
            errors.push('Telefone alternativo deve ser v√°lido');
        }

        return {
            isValid: errors.length === 0,
            errors: errors
        };
    }

    toJSON() {
        const baseJSON = super.toJSON();
        return {
            ...baseJSON,
            telefoneAlternativo: this.telefoneAlternativo.replace(/[^\d]/g, ''),
            disponibilidade: this.disponibilidade.trim(),
            observacoes: this.observacoes.trim()
        };
    }
}

// Estilos CSS adicionais para o sistema de m√∫ltiplos contatos
const additionalStyles = `
<style>
.badge-principal {
    background-color: #4CAF50;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 10px;
}

.contato-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.btn-set-primary {
    background-color: #FFC107;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.btn-set-primary:hover {
    background-color: #FFB300;
}

.contato-item {
    position: relative;
    transition: all 0.3s ease;
}

.contato-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.contato-item[data-is-primary="true"] {
    border-left: 4px solid #4CAF50;
}

.btn-adicionar-contato {
    margin-top: 15px;
}

.btn-adicionar-contato:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

@media (max-width: 768px) {
    .contato-actions {
        flex-direction: column;
        gap: 4px;
    }
    
    .btn-set-primary,
    .btn-remover-contato {
        font-size: 11px;
        padding: 3px 6px;
    }
}
</style>
`;

// Adiciona os estilos ao documento
document.head.insertAdjacentHTML('beforeend', additionalStyles);

// Exporta para uso global
window.MultipleContactsManager = MultipleContactsManager;
window.ContatoEstendidoDTO = ContatoEstendidoDTO;

